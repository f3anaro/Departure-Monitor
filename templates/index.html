<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{% block title %}Abfahrtsmonitor{% endblock %}</title>

    <link rel="stylesheet" type="text/css" href="assets/app.min.css">

    <script src="assets/jquery.min.js"></script>
    <script src="assets/bootstrap.min.js"></script>

  </head>
  <body>
    {% block body %}
      <div id="wrapper">
        <div class="row">
          <!-- left -->
          <div id="departure" class="col-md-7">
            {% include 'departure.html' with { 'stops': stops } %}
          </div>

          <!-- right -->
          <div id="weather">
            {% if display_weather %}
              {% include 'weather.html' with { 'weather': weather } %}
            {% endif %}
          </div>

        {# isn't a marquee really annoying?! :P #}
        <p class="lead"><marquee scrollamount='10' scrolldelay='10'>{{ marquee }}</marquee></p>

        <footer class="row">
          <div class="col-md-6"><p class="text-center">{{ "now" | date("H:i") }}</p></div>
          <div class="col-md-6"><p class="text-center">{{ "now" | date("d.m.Y")  }}</p></div>
        </div>
      </footer>

    {% endblock %}

    {% block javascripts %}
      <script>
        // timeout in milliseconds after which the weather section will be updated
        var timeouts = {
          weather:   60000 * 24, // 1h
          departure: 10000,      // 10s
        }
        var timers = {};

        var display_weather = {{ display_weather | json_encode() }};

        function updateWeather() {
          console.debug("Update weather ...");

          $.ajax({
            url: "update_weather.php",
            success: function(result) {
              // console.debug(result)

              // update HTML content
              $("#weather").html(result);
              console.debug("Weather update successful")

              // prevent multiple timers. this could occure if you call
              // the updateWeather() function in the JavaScript console 
              // of your browser
              if (timers.weather) {
                clearTimeout(timers.weather);
              }

              // set the timeout again
              timers.weather = setTimeout(updateWeather, timeouts.weather);
            },
            error: function(xhr, status, error) {
              console.error('!Error. status: ', status, ', message: ', error)
              console.error(xhr)
            },
          });

        }

        function updateDeparture() {
          console.debug("Update departure ...");

          $.ajax({
            url: "update_departure.php",
            success: function(result) {
              // console.debug(result)

              // update HTML content
              $("#departure").html(result);
              console.debug("Departure update successful")

              // prevent multiple timers. this could occure if you call
              // the updateWeather() function in the JavaScript console 
              // of your browser
              if (timers.departure) {
                clearTimeout(timers.departure);
              }

              // set the timeout again
              timers.departure = setTimeout(updateDeparture, timeouts.departure);
            },
            error: function(xhr, status, error) {
              console.error('!Error. status: ', status, ', message: ', error)
              console.error(xhr)
            },
          });
          
        }


        $(document).ready(function() {
            timers.departure = setTimeout(updateDeparture, timeouts.departure)

            if (display_weather) {
              timers.weather = setTimeout(updateWeather, timeouts.weather);
            }
        })
      </script>
    {% endblock %}

  </body>
</html>
